<!DOCTYPE html>
<html 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">
<section layout:fragment="content" class="contents d-flex justify-content-center">
	<div class="contents-box">		
		<!-- íƒ€ì„ë¼ì¸ ì˜ì—­ -->
		<div class="timeline-box">
			<!-- í¬ìŠ¤íŠ¸ -->
			<div class="card border rounded mt-3" th:each="cardView, iterStat : ${cardViewList}" th:if="${iterStat.index == 0}">
				<!-- ê¸€ ì œëª©, ë”ë³´ê¸°(ì‚­ì œ) -->
				<div class="d-flex justify-content-between align-items-center">
					<div class="d-flex  mb-4">
						<!-- ë’¤ë¡œê°€ê¸° -->
						<a href="/post/post-list-view" class="goBack-btn ml-3 mr-3">
							<img src="https://imagescdn.gettyimagesbank.com/500/19/213/635/0/1153376175.jpg" width="30">
						</a>
						<!-- ì œëª© -->
						<div th:text="${post.subject}" class="card-title mt-3">ê¸€ ì œëª©</div>
					</div>
					
					<!-- ë”ë³´ê¸°(...) -->
					<a href="#" class="more-btn mr-4 mb-5">
						<img src="https://www.iconninja.com/files/860/824/939/more-icon.png" width="30">
					</a>
				</div>
				
				<!-- ë³¸ë¬¸ ì´ë¯¸ì§€ (ì´ë¯¸ì§€ ìˆì„ ë•Œì—ë§Œ ì˜ì—­ ë…¸ì¶œ) -->
				<div class="card-img">
					<img th:if="${post.imagePath != null}" th:src="${post.imagePath}" width="400px" alt="ë³¸ë¬¸ ì´ë¯¸ì§€">
					<img th:unless="${post.imagePath != null}" src="/blog_img/none.jpg" class="d-none" alt="ê¸°ë³¸ ì´ë¯¸ì§€">
				</div>
				
				<!-- ê¸€ -->
				<div class="card-post m-3">
					<div th:text="${post.content}" class="text-secondary">ê¸€ ë‚´ìš©ì…ë‹ˆë‹¤!!!!</div>
				</div>
				
				<!-- ê³µê° ë²„íŠ¼-->
				<button class="card-like m-3 bg-dark" th:data-post-id="${cardView.post.id}" th:data-filled-like="${cardView.filledLike}">
					<small th:if="${cardView.filledLike == false}" th:text="|â™¥ ê³µê°|" class="text-white"></small>
					<small th:unless="${cardView.filledLike == false}" th:text="|â™¥ ${cardView.likeCount}ê°œ|" class="text-white"></small>
				</button>

				
				<!-- ëŒ“ê¸€ ëª©ë¡ -->
				<div class="card-comment-list m-2">
					<!-- ëŒ“ê¸€ë“¤ -->
					<div class="card-comment d-flex m-1" th:each="commentView : ${commentViewList}">
						<div class="font-weight-bold mr-2" th:text="${commentView.user.loginId}">ëŒ“ê¸€ì“´ì´</div>
						<div class="text-secondary mr-2" th:text="${commentView.comment.content}">ëŒ“ê¸€ ë‚´ìš©ì„</div>
						
						<!-- ëŒ“ê¸€ ì‚­ì œ(ìì‹ ì˜ ëŒ“ê¸€ë§Œ ê°€ëŠ¥) -->
						<a href="#" class="comment-del-btn" th:if="${session.userId == commentView.comment.userId}" th:data-comment-id="${commentView.comment.id}">
							<img src="/blog_img/delete.jpg" width="10" height="10">
						</a>
					</div>
					
					<!-- ëŒ“ê¸€ ì“°ê¸° -->
					<div class="comment-write d-flex border-top mt-2 border rounded">
						<input type="text" class="comment-input form-control border-0 mr-2" placeholder="ëŒ“ê¸€ ì…ë ¥">
						<button type="button" class="comment-btn btn text-white" th:data-post-id="${post.id}" th:data-user-id="${post.userId}">ë“±ë¡</button>
					</div>
				</div> <!-- ëŒ“ê¸€ ë -->
			</div> <!-- í¬ìŠ¤íŠ¸ ë -->
		</div> <!-- íƒ€ì„ë¼ì¸ ë°•ìŠ¤ ë -->
	</div>
</section>

<th:block layout:fragment="script">
    <script>
    $(document).ready(function() {
    	/* ëŒ“ê¸€ ì“°ê¸° */
    	$(".comment-btn").on('click', function() {
    		// alert("ëŒ“ê¸€ ë“±ë¡");
    		
    		//ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
    		let userId = $(this).data("user-id");
    		if (!userId) { // ë¹„ë¡œê·¸ì¸
				alert("ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.");
				location.href = "/user/sign-in-view";
				return;
			}
			
			// ê¸€ ë²ˆí˜¸ êº¼ë‚´ì˜¤ê¸° â†’ data-post-id
    		let postId = $(this).data("post-id");
    		//alert(postId);
    		
    		// â˜…í˜•ì œ íƒœê·¸ > input(ëŒ“ê¸€ë‚´ìš©) ê°€ì ¸ì˜¤ê¸° â†’ comment-input
    		let content = $(this).siblings("input").val().trim();
			console.log(content); 
			if (!content) {
				alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
				return;
			}
			
			// ajax
			$.ajax({
				type:"post"
				, url:"/comment/create"
				, data:{"postId":postId, "content":content}
				, success:function(data) {
					if (data.code == 200) {
						location.reload(true); 
					} else if (data.code == 403) { // ë¹„ë¡œê·¸ì¸
						alert(data.error_message);
						location.href="/user/sign-in-view";
					} else {
						alert(data.error_message);
					}
				}
				, error:function(error) {
					alert("ëŒ“ê¸€ ì“°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
				
			});
			
        });
    	
    	/* ëŒ“ê¸€ ì‚­ì œ */
    	$(".comment-del-btn").on('click', function(e) {
			e.preventDefault(); // ìœ„ë¡œ ì˜¬ë¼ê° ë°©ì§€
			
			let commentId = $(this).data("comment-id");
			//alert(commentId);
			
			$.ajax({
				type:"DELETE"
				, url:"/comment/delete"
				, data:{"commentId":commentId}
				, success:function(data) {
					if (data.code == 200) {
						location.reload(true);
					} else if (data.code == 403) { // ë¹„ë¡œê·¸ì¸
						alert(data.error_message);
						location.href="/user/sign-in-view";
					} else {
						alert(data.error_message);
					}
				}
				, error:function(request, status, error) {
					alert("ëŒ“ê¸€ ì‚­ì œ í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
			});
		});
    	
    	/* ê³µê° Toggle */
        $(".card-like").on('click', function(e) {
        	e.preventDefault();
			//alert("ê³µê° í† ê¸€");
			
            
            // ê¸€ ë²ˆí˜¸ êº¼ë‚´ì˜¤ê¸° â†’ data-post-id
            let postId = $(this).data("post-id");
            
            // ê³µê° ë²„íŠ¼ ì´ë²¤íŠ¸
            let isFilledLike = $(this).data("filled-like");
            if (isFilledLike) {
                alert("ê³µê° í•´ì œğŸš«");
            } else {
            	alert("ê³µê° ê¾¹â¤ï¸");
            }
            
            // ajax ìš”ì²­
            $.ajax({
                type: "POST",
                url: "/like/" + postId,
                success: function(data) {
                    if (data.code == 200) {
                        location.reload(true); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    } else if (data.code == 403) { // ë¹„ë¡œê·¸ì¸
                        alert(data.error_message);
                        location.href = "/user/sign-in-view";
                    } else {
                        alert(data.error_message);
                    }
                },
                error: function() {
                    alert("ê³µê° ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
    }); //--ready
    
    </script>
</th:block>